name: Release

on:
  push:
    tags:
      - "v*-linux-*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag name (e.g.: v1.0.0)"
        required: true
        type: string

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract changelog for current version
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: CHANGES.md
          GITHUB_REPO: ${{ github.repository }}

  build:
    name: Build
    strategy:
      matrix:
        out:
          - os: ubuntu-22.04
            rust_target: x86_64-unknown-linux-gnu
          - os: ubuntu-22.04-arm
            rust_target: aarch64-unknown-linux-gnu
    runs-on: ${{ matrix.out.os }}
    environment: TAURI_KEY
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Setup bun
        id: setup-bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Setup bun cache
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-${{ steps.setup-bun.outputs.bun_version }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ steps.setup-bun.outputs.bun_version }}-bun-

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.out.rust_target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies
        run: bun install
      - name: install dependencies for build
        run: sudo apt-get update && sudo apt-get install -y libgtk-3-dev libsoup-3.0-dev libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
      - name: Get version
        id: get_version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version is $VERSION"
      - name: Compute short target name
        id: short
        shell: bash
        run: |
          case "${{ matrix.out.rust_target }}" in
            *x86_64*) SHORT=linux_amd64 ;;
            *aarch64*) SHORT=linux_arm64 ;;
            *) SHORT=unknown ;;
          esac
          echo "SHORT=$SHORT" >> $GITHUB_OUTPUT
      - name: Build and Upload to Draft Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # tagName: ${{ github.ref_name }}
          tagName: ""
          # releaseName: ${{ github.ref_name }}
          releaseName: ""
          # releaseBody: ${{ needs.prepare.outputs.changelog }}
          releaseBody: ""
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: false
          includeDebug: false
          includeRelease: true
          tauriScript: bun tauri
          args:
            --target ${{ matrix.out.rust_target }}
            # Upload build artifacts for testings
      - name: Upload deb (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: ReinaManager-${{ steps.get_version.outputs.VERSION }}-${{ steps.short.outputs.SHORT }}-deb
          path: src-tauri/target/${{ matrix.out.rust_target }}/release/bundle/deb/*.deb
          if-no-files-found: warn
      - name: Upload rpm (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: ReinaManager-${{ steps.get_version.outputs.VERSION }}-${{ steps.short.outputs.SHORT }}-rpm
          path: src-tauri/target/${{ matrix.out.rust_target }}/release/bundle/rpm/*.rpm
          if-no-files-found: warn
      - name: Upload AppImage (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: ReinaManager-${{ steps.get_version.outputs.VERSION }}-${{ steps.short.outputs.SHORT }}-appimage
          path: src-tauri/target/${{ matrix.out.rust_target }}/release/bundle/appimage/*.AppImage
          if-no-files-found: warn
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v5
        with:
          path: release-artifacts
          pattern: ReinaManager-*
          merge-multiple: true
      - name: Create Github Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Release ${{ inputs.tag_name == '' && github.ref_name || inputs.tag_name }}
          immutableCreate: true
          body: ${{ needs.prepare.outputs.changelog }}
          artifacts: "release-artifacts/ReinaManager*.deb,release-artifacts,ReinaManager*.rpm,release-artifacts/ReinaManager*.AppImage"
          makeLatest: true
  # finalize-release:
  #   name: Finalize Release
  #   runs-on: ubuntu-latest
  #   needs: [prepare, build-and-upload] # ç­‰å¾…æ‰€æœ‰æ„å»ºå’Œä¸Šä¼ å®Œæˆ
  #   permissions:
  #     contents: write # éœ€è¦æƒé™æ¥ç¼–è¾‘ release
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Determine release type
  #       id: release-type
  #       shell: bash
  #       run: |
  #         if [[ "${{ github.ref_name }}" == *"alpha"* ]] || [[ "${{ github.ref_name }}" == *"beta"* ]] || [[ "${{ github.ref_name }}" == *"rc"* ]] || [[ "${{ github.ref_name }}" == *"pre"* ]] || [[ "${{ github.event.inputs.prerelease }}" == "true" ]]; then
  #           echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
  #         else
  #           echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
  #         fi

  #     - name: Prepare Release Body
  #       id: release_body
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       shell: bash
  #       run: |
  #         TAG_NAME="${{ github.ref_name }}"
  #         # ä» GitHub API è·å–è‰ç¨¿ release çš„æ‰€æœ‰èµ„æºæ–‡ä»¶å
  #         ASSETS_JSON=$(gh release view "$TAG_NAME" --json assets --jq '.assets | .[] | .name')

  #         # æŸ¥æ‰¾ MSI å’Œ EXE æ–‡ä»¶
  #         X64_MSI=$(echo "$ASSETS_JSON" | grep -E "_x64_.*\.msi$" || echo "")
  #         ARM64_MSI=$(echo "$ASSETS_JSON" | grep -E "_arm64_.*\.msi$" || echo "")

  #         CHANGELOG="${{ needs.prepare.outputs.changelog }}"

  #         # ä¸ºæ‰€æœ‰æ–‡ä»¶åˆ›å»º URL
  #         X64_MSI_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/$X64_MSI"
  #         ARM64_MSI_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/$ARM64_MSI"

  #         DOWNLOAD_SECTION=$(cat <<EOF
  #         ---
  #         ### ğŸ“¥ ä¸‹è½½åœ°å€ (Download)
  #         ![Downloads](https://img.shields.io/github/downloads/${{ github.repository }}/$TAG_NAME/total)

  #         **Windows** (ä¸æ”¯æŒ Win7)
  #           - [**64ä½ (x64)**]($X64_MSI_URL)
  #           - [**ARM64**]($ARM64_MSI_URL)
  #         EOF
  #         )

  #         FINAL_BODY=$(cat <<EOF
  #         $CHANGELOG

  #         $DOWNLOAD_SECTION
  #         EOF
  #         )

  #         {
  #           echo "body<<EOF"
  #           echo "$FINAL_BODY"
  #           echo "EOF"
  #         } >> $GITHUB_OUTPUT

  #     - name: Publish Final Release
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         tag_name: ${{ github.ref_name }}
  #         body: ${{ steps.release_body.outputs.body }}
  #         draft: false
  #         prerelease: ${{ steps.release-type.outputs.IS_PRERELEASE }}

  # update_cdn_urls:
  #   name: Update CDN URLs in latest.json
  #   runs-on: ubuntu-latest
  #   needs: finalize-release # ç­‰å¾… release æ­£å¼å‘å¸ƒ
  #   if: startsWith(github.ref, 'refs/tags/')
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Update latest.json with CDN URLs
  #       shell: bash
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         TAG_NAME="${{ github.ref_name }}"
  #         URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/latest.json"

  #         n=0
  #         until [ "$n" -ge 5 ]; do
  #           curl -L -f -o latest.json "$URL" && break
  #           n=$((n+1))
  #           sleep 5
  #         done

  #         if [ ! -f "latest.json" ]; then
  #           echo "Error: Could not download latest.json after several retries."
  #           exit 1
  #         fi

  #         jq '.platforms |= with_entries(.value.url |= "https://gh.huoshen80.top/\(.)")' latest.json > latest_modified.json
  #         mv -f latest_modified.json latest.json

  #         gh release upload $TAG_NAME "latest.json" --clobber
  #         echo "Successfully updated latest.json with CDN URLs"
